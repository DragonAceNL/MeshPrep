<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MeshPrep Thingi10K Test Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1720;
            color: #dff6fb;
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #4fe8c4; margin-bottom: 10px; }
        .subtitle { color: #888; margin-bottom: 30px; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #1b2b33;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #4fe8c4;
        }
        .stat-label { color: #888; margin-top: 5px; }
        
        .progress-bar {
            background: #1b2b33;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin-bottom: 30px;
        }
        .progress-fill {
            background: linear-gradient(90deg, #4fe8c4, #2ecc71);
            height: 100%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #0f1720;
        }
        
        .current-file {
            background: #1b2b33;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #333;
            border-top-color: #4fe8c4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .spinner.stopped {
            animation: none;
            border-top-color: #888;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .success { color: #2ecc71; }
        .failed { color: #e74c3c; }
        .escalated { color: #f39c12; }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-running { background: #2ecc71; color: #0f1720; }
        .status-stopped { background: #e74c3c; color: white; }
        .status-complete { background: #4fe8c4; color: #0f1720; }
        
        .error-box {
            background: #2a1a1a;
            border: 1px solid #e74c3c;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .error-box h3 { color: #e74c3c; margin-top: 0; }
        
        .info-box {
            background: #1a2a2a;
            border: 1px solid #4fe8c4;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .info-box h3 { color: #4fe8c4; margin-top: 0; }
        code {
            background: #0f1720;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
        }
        
        .links-row {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .link-btn {
            display: inline-block;
            background: #1b2b33;
            color: #4fe8c4;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            border: 1px solid #4fe8c4;
        }
        .link-btn:hover {
            background: #4fe8c4;
            color: #0f1720;
        }
        .link-btn.primary {
            background: #4fe8c4;
            color: #0f1720;
        }
        .link-btn.primary:hover {
            background: #3dd4b0;
        }
        
        .refresh-info {
            margin-top: 30px;
            color: #666;
            font-size: 12px;
        }
        
        #lastUpdate { color: #4fe8c4; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß MeshPrep Thingi10K Test Dashboard</h1>
        
        <div id="errorBox" class="error-box" style="display: none;">
            <h3>‚ö†Ô∏è Cannot Load Progress</h3>
            <p>The dashboard cannot read progress data. Make sure the reports server is running.</p>
            <p><strong>To start the server:</strong></p>
            <ol>
                <li>Open PowerShell in <code>C:\Users\Dragon Ace\Source\repos\MeshPrep\poc\v3</code></li>
                <li>Run: <code>..\v2\.venv312\Scripts\python.exe reports_server.py</code></li>
                <li>Open: <a href="http://localhost:8000/live" style="color: #4fe8c4;">http://localhost:8000/live</a></li>
            </ol>
        </div>
        
        <div id="mainContent" style="display: none;">
            <p class="subtitle">
                <span id="statusBadge" class="status-badge status-stopped">STOPPED</span>
                Started: <span id="startTime">-</span> | 
                Last Update: <span id="lastUpdate">-</span>
                <span id="etaSpan" style="color: #888;">| ETA: <span id="eta">-</span></span>
            </p>
            
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%">
                    <span id="progressText">0% (0 / 0)</span>
                </div>
            </div>
            
            <div class="current-file">
                <div id="spinner" class="spinner stopped"></div>
                <div style="flex: 1;">
                    <div>
                        Currently processing: <strong id="currentFile">-</strong>
                        <a id="currentFileLink" href="#" style="display: none; margin-left: 10px; color: #4fe8c4; font-size: 12px;">View Report ‚Üí</a>
                    </div>
                    <div id="currentActionContainer" style="margin-top: 5px; font-size: 14px; color: #888;">
                        Action: <span id="currentAction" style="color: #4fe8c4;">-</span>
                        <span id="actionProgress" style="margin-left: 10px;"></span>
                    </div>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalModels">0</div>
                    <div class="stat-label">Total Models</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value success" id="successful">0</div>
                    <div class="stat-label">Successful</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value failed" id="failed">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value escalated" id="escalations">0</div>
                    <div class="stat-label">Escalations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #3498db;" id="precheckSkipped">0</div>
                    <div class="stat-label">Already Clean</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #9b59b6;" id="reconstructed">0</div>
                    <div class="stat-label">Reconstructed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgDuration">0s</div>
                    <div class="stat-label">Avg Duration</div>
                </div>
            </div>
            
            <div class="links-row">
                <a href="/reports/" class="link-btn primary">üìã Browse Reports Index</a>
                <a href="/learning" class="link-btn">üß† Learning Status</a>
            </div>
            
            <div class="info-box">
                <h3>üìÅ Output Locations</h3>
                <p><strong>Reports:</strong> <a href="/reports/" style="color: #4fe8c4;">/reports/</a> - HTML reports with before/after images</p>
                <p><strong>Fixed Models:</strong> <a href="/fixed/" style="color: #4fe8c4;">/fixed/</a> - Successfully repaired STL files</p>
                <p><strong>Filter Scripts:</strong> <a href="/reports/filters/" style="color: #4fe8c4;">/reports/filters/</a> - JSON files showing repair actions</p>
            </div>
        </div>
        
        <p class="refresh-info">
            Dashboard refreshes every 5 seconds. Last check: <span id="lastCheck">-</span>
            <button onclick="loadProgress()" style="margin-left: 10px; padding: 4px 12px; cursor: pointer;">Refresh Now</button>
        </p>
    </div>
    
    <script>
        let lastUpdateTime = null;
        
        function formatTime(isoString) {
            if (!isoString) return '-';
            try {
                const date = new Date(isoString);
                return date.toLocaleTimeString();
            } catch {
                return isoString.substring(11, 19);
            }
        }
        
        function formatDuration(seconds) {
            if (seconds <= 0) return 'Calculating...';
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            if (hours > 0) return `${hours}h ${mins}m`;
            if (mins > 0) return `${mins}m ${secs}s`;
            return `${secs}s`;
        }
        
        function updateDashboard(data) {
            document.getElementById('errorBox').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            const p = data;
            const percentComplete = p.total_files > 0 ? (p.processed / p.total_files * 100) : 0;
            const successRate = p.processed > 0 ? (p.successful / p.processed * 100) : 0;
            
            // Check if running (updated in last 5 minutes - Blender can take a while)
            const lastUpdate = new Date(p.last_update);
            const now = new Date();
            const secondsSinceUpdate = (now - lastUpdate) / 1000;
            const isRunning = secondsSinceUpdate < 300;  // 5 minutes timeout
            const isComplete = p.processed >= p.total_files && p.total_files > 0;
            
            // Status badge
            const badge = document.getElementById('statusBadge');
            if (isComplete) {
                badge.textContent = 'COMPLETE';
                badge.className = 'status-badge status-complete';
            } else if (isRunning) {
                badge.textContent = 'RUNNING';
                badge.className = 'status-badge status-running';
            } else {
                badge.textContent = 'STOPPED';
                badge.className = 'status-badge status-stopped';
            }
            
            // Spinner
            document.getElementById('spinner').className = isRunning ? 'spinner' : 'spinner stopped';
            
            // Times
            document.getElementById('startTime').textContent = formatTime(p.start_time);
            document.getElementById('lastUpdate').textContent = formatTime(p.last_update);
            document.getElementById('eta').textContent = formatDuration(p.eta_seconds);
            
            // Progress bar
            document.getElementById('progressFill').style.width = percentComplete + '%';
            document.getElementById('progressText').textContent = 
                `${percentComplete.toFixed(1)}% (${p.processed.toLocaleString()} / ${p.total_files.toLocaleString()})`;
            
            // Current file
            const currentFileEl = document.getElementById('currentFile');
            const currentFileLink = document.getElementById('currentFileLink');
            currentFileEl.textContent = p.current_file || '-';
            
            // Show link to report if file exists
            if (p.current_file && p.current_file !== '-') {
                currentFileLink.href = `/reports/${p.current_file}.html`;
                currentFileLink.style.display = 'inline';
            } else {
                currentFileLink.style.display = 'none';
            }
            
            // Current action
            const actionContainer = document.getElementById('currentActionContainer');
            const currentAction = document.getElementById('currentAction');
            const actionProgress = document.getElementById('actionProgress');
            
            // Always show current action if it exists (even if stopped)
            if (p.current_action) {
                actionContainer.style.display = 'block';
                currentAction.textContent = p.current_action;
                
                let progressText = '';
                if (p.current_step && p.total_steps) {
                    progressText = `(step ${p.current_step} of ${p.total_steps})`;
                }
                
                // Show elapsed time for long-running actions (> 30 seconds)
                if (secondsSinceUpdate > 30) {
                    const elapsed = formatDuration(secondsSinceUpdate);
                    progressText += ` ‚Äî running for ${elapsed}`;
                }
                
                actionProgress.textContent = progressText;
            } else if (isRunning) {
                actionContainer.style.display = 'block';
                currentAction.textContent = 'Waiting...';
                actionProgress.textContent = '';
            } else {
                actionContainer.style.display = 'none';
            }
            
            // Stats
            document.getElementById('totalModels').textContent = p.total_files.toLocaleString();
            document.getElementById('successful').textContent = p.successful.toLocaleString();
            document.getElementById('failed').textContent = p.failed.toLocaleString();
            document.getElementById('escalations').textContent = p.escalations.toLocaleString();
            document.getElementById('precheckSkipped').textContent = (p.precheck_skipped || 0).toLocaleString();
            document.getElementById('reconstructed').textContent = (p.reconstructed || 0).toLocaleString();
            document.getElementById('successRate').textContent = successRate.toFixed(1) + '%';
            document.getElementById('avgDuration').textContent = (p.avg_duration_ms / 1000).toFixed(1) + 's';
        }
        
        async function loadProgress() {
            document.getElementById('lastCheck').textContent = new Date().toLocaleTimeString();
            
            try {
                // Use the new API endpoint (also supports legacy progress.json path)
                const response = await fetch('/api/progress?' + Date.now());
                if (!response.ok) throw new Error('Not found');
                const data = await response.json();
                updateDashboard(data);
            } catch (e) {
                document.getElementById('errorBox').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
            }
        }
        
        // Load immediately and then every 5 seconds
        loadProgress();
        setInterval(loadProgress, 5000);
    </script>
</body>
</html>
